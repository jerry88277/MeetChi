---
name: sisyphus-orchestrator
description: Sisyphus 風格任務協調器 - 整合 Prometheus(規劃)、Atlas(執行)、Sisyphus(持續) 三巨頭架構的多步驟任務調度
---

# Sisyphus Orchestrator Skill

這個 skill 實現了類似 OpenCode oh-my-opencode 的 Sisyphus agent 任務調度邏輯，採用 **Prometheus-Atlas-Sisyphus 三巨頭架構**處理複雜的多步驟任務。

---

## 核心原則

### 1. Boulder Mode（巨石模式）
像西西弗斯推巨石一樣，**持續執行直到任務 100% 完成**。不允許中途放棄或「差不多就好」。

### 2. The Enforcer（強制完成機制）🔴 關鍵
每個階段結束時**強制檢查**完成度：
- 任務清單是否全部 `[x]`？
- 所有驗證項目是否通過？
- 是否有未解決的錯誤？

**如果任一檢查失敗 → 自動返回繼續處理，不要停止或詢問用戶**

### 3. Verify-Then-Proceed（先驗證再前進）
每個步驟必須有明確的**預期結果**和**驗證指標**，驗證通過才能進入下一步。

### 4. Context-Lean（上下文精簡）
將探索性工作分離到專門步驟，保持主任務上下文精簡高效。

---

## 三巨頭思維模式

在處理任務時，根據階段切換思維模式：

### 🔮 Prometheus 思維（規劃時）
- 分析**隱藏意圖**和**潛在失敗點**
- 識別任務間的**依賴關係**
- 預測可能的陷阱並提前規劃備選方案
- 產出：結構化任務計畫

### ⚙️ Atlas 思維（執行時）
- 專注於**高效執行**和**進度追蹤**
- 每步驟驗證，發現問題立即修復
- 累積學習經驗，優化後續步驟
- 產出：代碼變更和執行記錄

### 🪨 Sisyphus 思維（持續時）
- **絕不放棄**，直到任務 100% 完成
- 遇到障礙時自動進入修復循環
- 維持「巨石必須到達山頂」的堅持
- 產出：完整的任務交付

---

## 工作流程

### 階段 1：Investigate（調查）

**目標**：完整理解任務上下文和現有代碼。

**步驟**：
1. 識別任務涉及的模組和文件
2. 使用 `grep_search` 或 `find_by_name` 定位相關代碼
3. 使用 `view_file` 或 `view_file_outline` 了解現有實現
4. 記錄發現的模式和約定

**驗證指標**：
- [ ] 列出所有涉及的文件
- [ ] 理解現有代碼的設計模式
- [ ] 識別類似實現可供參考
- [ ] 確認沒有遺漏的相關模組

**失敗處理**：若發現遺漏，返回繼續搜索直到完整。

---

### 階段 2：Plan（規劃）

**目標**：建立可執行、可驗證的詳細計畫。

**步驟**：
1. 將任務拆解為原子步驟
2. 為每個步驟定義預期結果和驗證指標
3. 識別潛在風險和備選方案
4. 確定步驟間的依賴順序

**步驟執行模板**：
```markdown
### 步驟 N：[步驟名稱]

**描述**：要做什麼
**涉及文件**：file1.py, file2.py
**預期結果**：成功會看到什麼
**驗證指標**：
- [ ] 指標 1
- [ ] 指標 2
**風險**：可能遇到的問題
**備選方案**：失敗時的替代方法
```

**驗證指標**：
- [ ] 所有步驟都有明確的驗證指標
- [ ] 步驟順序合理（依賴關係正確）
- [ ] 高風險步驟有備選方案

---

### 階段 3：Implement（實作）

**目標**：按計畫逐步執行，持續追蹤進度。

**執行原則**：
1. 嚴格按順序處理每個步驟
2. 開始步驟前標記 `[/]`，完成後標記 `[x]`
3. 每步完成後立即驗證
4. 遇到問題記錄並進入 Ralph Loop

**實作標準**：
- 遵循專案現有的代碼風格
- 優先使用現有的工具函數
- 添加必要的錯誤處理
- 保持函數的單一職責
- 變更應最小化且可追溯

**驗證指標**：
- [ ] 步驟代碼無語法錯誤
- [ ] 相關 import 無警告
- [ ] 步驟預期結果達成

---

### 階段 4：Verify（驗證）

**目標**：確保所有變更正確且完整。

**驗證清單**：
- [ ] 所有代碼可正常執行
- [ ] 沒有引入新的錯誤或警告
- [ ] 功能符合原始任務需求
- [ ] 文檔已更新（如需要）
- [ ] 邊緣情況已處理

**驗證方法**：
1. 運行相關測試（如有）
2. 檢查 LSP/linter 診斷
3. 手動驗證關鍵功能
4. 檢視變更摘要確認完整性

---

## 控制機制

### Ralph Loop（自動修復循環）

當步驟執行遇到錯誤時，**自動進入修復循環**：

```
attempts = 0
max_attempts = 3

while true:
    1. 分析錯誤訊息 → 識別根本原因
    2. 提出修復方案
    3. 執行修復
    4. 驗證結果
    
    if 驗證通過:
        記錄成功經驗
        break  // 退出循環，繼續下一步
    
    attempts += 1
    if attempts >= max_attempts:
        記錄詳細錯誤和所有嘗試
        詢問用戶是否有額外上下文
        break
```

**關鍵點**：前 3 次嘗試自動進行，不要停下來詢問用戶。

---

### Enforcer 檢查點

在每個階段結束時執行：

```
function enforcer_check(phase):
    checks = {
        'tasks_complete': all(task.status == '[x]' for task in plan.tasks),
        'verification_passed': all(v.passed for v in phase.verifications),
        'no_errors': len(current_errors) == 0
    }
    
    if not all(checks.values()):
        identify_unfinished_items()
        return_to_processing()  // 自動返回繼續
    else:
        proceed_to_next_phase()
```

**黃金規則**：**只有當所有檢查通過時，才能向用戶報告完成。**

---

### 上下文管理策略

當上下文接近限制時：

1. **分離探索**：將搜索和閱讀操作獨立執行，只保留摘要
2. **步驟隔離**：專注當前步驟，已完成步驟只保留結果
3. **摘要記錄**：長輸出轉為簡潔摘要

---

## 任務分類

根據任務類型選擇適當的處理策略：

### TTS Engineering（語音合成）
- **涉及**：`src/core/tts.py`, `CosyVoice/`, `GPT-SoVITS-v2pro-*/`
- **重點**：音訊格式、採樣率、模型參數
- **驗證**：播放輸出音訊確認品質
- **常見陷阱**：採樣率不匹配、GPU 記憶體不足

### Video Generation（影片生成）
- **涉及**：`src/core/motion.py`, `LivePortrait/`
- **重點**：幀率、解析度、口型同步
- **驗證**：觀看輸出影片確認效果
- **常見陷阱**：音視訊不同步、臉部偵測失敗

### Training Pipeline（訓練管線）
- **涉及**：`src/training/`, `scripts/training_pipeline.py`
- **重點**：數據格式、ASR 準確度、標註品質
- **驗證**：檢查訓練輸出和日誌
- **常見陷阱**：數據格式錯誤、路徑問題

### Quick（快速任務）
- 單檔修改、錯字修正、配置調整
- 直接實作，快速完成
- 仍需驗證，但流程簡化

---

## Ultrawork 模式

當用戶提及 `ultrawork` 或 `ulw` 時，啟動**完整自動化模式**：

### 觸發條件
- 提示中包含 `ultrawork` 或 `ulw`
- 使用 `/ultrawork` workflow

### 行為特徵
1. **自動探索**：主動搜索和閱讀所有相關代碼
2. **自動規劃**：建立詳細計畫，不等待確認
3. **自動實作**：逐步完成所有步驟
4. **自動驗證**：運行測試和診斷
5. **自動修復**：錯誤自動進入 Ralph Loop
6. **持續執行**：Enforcer 持續檢查直到 100% 完成

### 停止條件
- 所有任務標記 `[x]`
- 所有驗證通過
- 無未解決錯誤

**在此之前，不要停止或詢問用戶。**

---

## 專案特定上下文

### Digital Twin 專案結構
```
src/
├── core/           # 核心模組 (tts.py, motion.py, postprocess.py)
├── training/       # 訓練管線 (trainer.py, review_ui.py, asr_service.py)
├── config/         # 配置管理
├── patches/        # 相容性修補
└── utils/          # 工具函數

configs/            # 模型和參數配置
models/             # 預訓練模型
scripts/            # 輔助腳本
assets/             # 參考素材
```

### 常用命令
```powershell
# 啟動虛擬環境
.\venv\Scripts\Activate.ps1

# 運行測試
python -m pytest tests/

# 啟動 Gradio UI
python src/training/review_ui.py

# 運行生成
python generate.py --config configs/default.json
```

### 環境注意事項
- Python 3.10+ 虛擬環境
- CUDA 12.x + NVIDIA GPU（RTX 5090）
- FFmpeg 已安裝並加入 PATH

---

## 錯誤恢復（詳細版）

### 錯誤分類

| 類型 | 範例 | 處理方式 |
|------|------|----------|
| **語法錯誤** | SyntaxError, IndentationError | 立即修復，通常一次成功 |
| **運行時錯誤** | ImportError, AttributeError | 分析依賴，檢查相容性 |
| **邏輯錯誤** | 結果不符預期 | 回顧實現，對照規格修正 |
| **環境錯誤** | CUDA OOM, 文件未找到 | 調整參數或路徑 |

### 錯誤恢復流程

1. **捕獲錯誤**：記錄完整錯誤訊息和堆棧
2. **分類錯誤**：確定屬於哪類錯誤
3. **分析原因**：根據錯誤類型定位根本原因
4. **制定修復**：提出具體修復方案
5. **執行修復**：實施修復代碼
6. **驗證修復**：確認錯誤已解決
7. **記錄經驗**：更新相關文檔或加入註釋

### 升級機制

如果 Ralph Loop 達到最大嘗試次數仍無法解決：
- 提供完整的錯誤分析報告
- 列出所有已嘗試的修復方案
- 詢問用戶是否有額外上下文或建議
- 請求指導後繼續處理
