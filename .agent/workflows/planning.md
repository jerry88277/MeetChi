---
description: 規劃模式 - Prometheus 式深度需求面試 + 結構化計畫生成（整合 opencode-prometheus skill）
---

# /plan — 規劃模式工作流程

適用於複雜或關鍵任務。透過結構化面試釐清需求，生成可執行的實施計畫。

> **參考 Skill**: `opencode-prometheus`（面試流程）、`opencode-supporting-agents`（Metis 缺口分析）

## 步驟 1：意圖分類

先判斷任務類型，決定面試策略：

| 意圖 | 面試重點 | 關鍵問題 |
|------|---------|---------|
| 重構 | 安全性 — 行為保留 | "哪些測試驗證現有行為？回滾策略？" |
| 從零建構 | 發現 — patterns first | "codebase 中有類似的實作嗎？要遵循還是偏離？" |
| 中型任務 | 邊界 — 防止 AI 工程過度 | "明確不應包含什麼？硬性約束？" |
| 架構設計 | 策略 — 長期影響 | "預期壽命？擴展要求？" |
| 除錯 | 精確 — 重現與隔離 | "錯誤訊息？重現步驟？上次正常是什麼時候？" |

## 步驟 2：代碼探索（與面試並行）

在面試過程中，**同步進行**代碼探索：
- 使用 `grep_search`、`find_by_name`、`view_file_outline` 搜索相關程式碼
- 識別現有設計模式和可重用元件
- 找出實際的 patterns 來指導面試問題

> **重要**: 先探索，再提問。用發現的事實來引導問題，而非憑空提問。

## 步驟 3：需求面試（Prometheus 式）

逐步確認以下五個維度，每個維度都明確後才進入下一步：

1. **核心目標** — 具體要達成什麼？成功的定義是什麼？
2. **範圍邊界** — 包含什麼？**明確排除什麼？**
3. **關鍵模糊點** — 有哪些未決定的技術選擇？
4. **技術方案** — 採用哪種實作方式？為什麼？
5. **驗證策略** — 怎麼確認做對了？測試命令是什麼？

### AI-Slop 防護（Metis 思維）

面試時主動詢問以防止過度工程：

| 模式 | 示例 | 應該問的問題 |
|------|------|-------------|
| 範圍膨脹 | "順便也寫鄰近模組的測試" | "測試範圍只到 [TARGET] 嗎？" |
| 過早抽象 | "抽取成 utility 函數" | "要抽象化，還是保持 inline？" |
| 過度驗證 | "3 個輸入做 15 種錯誤檢查" | "錯誤處理：最小化還是全面？" |
| 文件膨脹 | "每個函數都加 JSDoc" | "文件：無 / 最小 / 完整？" |

## 步驟 4：生成實施計畫

面試結束後，在 brain 目錄建立 `implementation_plan.md`：

```markdown
# [任務名稱] 實施計畫

## 背景與目的
[為什麼要做這個 + 使用者的核心需求]

## 關鍵決策
[面試過程中使用者做出的決策]

## 提議的變更

### [元件名稱]
#### [MODIFY/NEW/DELETE] [file.py](file:///absolute/path)
- **做什麼**: [具體變更]
- **必須做**: [明確要求]
- **不可做**: [禁止行為]
- **參考**: [follow pattern in 某檔案:行號]

## 驗證計畫
- [具體的測試/驗證命令]
- [預期結果]
```

## 步驟 5：用戶審閱

使用 `notify_user` 請求審閱：
- 提供 `implementation_plan.md` 路徑
- 設定 `BlockedOnUser: true`
- 等待用戶確認再執行

## 步驟 6：執行計畫

用戶確認後，切換到 EXECUTION 模式：
- 按計畫中的任務順序執行
- 識別無依賴的任務群組並行處理
- 每完成一個任務立即標記 `[x]`
- 驗證每個步驟的結果
- 累積 Wisdom（發現的 gotchas、成功/失敗的方法）

## 步驟 7：驗證和報告

- 按驗證計畫執行測試
- 建立 `walkthrough.md` 記錄結果
- 向用戶報告完成情況
