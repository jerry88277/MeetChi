# MVP 功能設計文件 (Function Design)

根據需求文件 (Rev 2)，我們將 MVP 功能設計拆解為以下核心模組。

## 1. 前端音訊捕獲模組 (Client-Side Audio Capture)
- **職責**: 捕捉、處理並傳送音訊。
- **設計**:
    - 使用 **Web Audio API** (`AudioContext`) 獲取使用者麥克風或系統音訊。
    - 內建 **前端靜音過濾 (Frontend VAD)**，僅在音量超過閾值時傳送，並具備預先緩衝 (Pre-buffering) 機制以防止首句遺失。
    - **Electron 整合**: 在桌面環境下，使用 `desktopCapturer` API 獲取系統音訊流，解決瀏覽器權限限制。

## 2. 即時通訊閘道模組 (Real-time Communication Gateway)
- **職責**: 作為前後端與後端微服務之間的中介。
- **設計**:
    - 使用 **FastAPI** 建立 WebSocket 端點。
    - 支援 `config` 訊息，接收前端傳來的 `initial_prompt` 與語言設定。
    - 處理音訊流的 VAD 切分 (後端 VAD) 與 ASR 任務分派。

## 3. ASR 轉錄與 LLM 潤飾模組 (Core Processing)
- **ASR**: 使用 `faster-whisper` (CTranslate2)。
- **LLM**: 使用 `Breeze-3B`。
- **流程**: Audio -> VAD (Split) -> ASR (Raw Text) -> LLM (Polished & Translated Text) -> WebSocket (Response)。

## 4. 前端 UI 架構：沉浸式桌面版 (Immersive Desktop UI Architecture)

### 4.1 主視窗 (Main Window - Subtitle Display)
- **佈局**:
    - **Top Bar (Title Bar)**:
        - **Visibility**: `opacity: isHovered ? 1 : 0`，CSS transition 實現平滑淡入淡出。
        - **Left**: App Title (Drag Region)。
        - **Center**: 
            - **Record/Stop Toggle**: 錄音控制。
            - **Settings Button (Gear)**: 開啟設定 Modal。
        - **Right**: Minimize / Maximize / Close (Electron IPC)。
    - **Content Area (Subtitles)**:
        - **Layout**: 佔滿剩餘空間。
        - **Interaction**: 
            - `onClick`: 切換 `isRecording` 狀態。
            - **Overlay Icon**: 點擊時中央顯示短暫的 Play/Pause 圖示動畫。
        - **Style**:
            - Background: `rgba(0,0,0, config.opacity)`。
            - Font: `config.fontSize`。
            - Max Lines: 透過計算高度或 CSS `line-clamp` (若支援) 限制顯示行數，多餘的自動捲動隱藏。

### 4.2 設定視窗 (Settings Modal)
- **定位**: 模態對話框 (Overlay on Main Window)。
- **行為**: 點擊 Title Bar 齒輪開啟，點擊背景或關閉按鈕關閉。
- **Sections**:
    - **Audio**: Source (Mic/System).
    - **Language**: Mode (Single/Dual), Direction (ZH<->EN).
    - **Display**: Font Size (Slider), Opacity (Slider), Lines (Number Input).
    - **AI Context**: Initial Prompt (Textarea).

## 5. 資料結構與狀態管理 (Data & State)
- **React State**:
    - `isHovered`: boolean (追蹤滑鼠是否在視窗內)。
    - `showSettings`: boolean (控制設定 Modal 顯示)。
    - `isRecording`: boolean。
    - `config`: {...} (Persistent).
- **Electron IPC**:
    - 維持現有的 `window-minimize` 等指令。