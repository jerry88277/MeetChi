# MVP 功能設計文件 (Functional Design) - Phase 2: 結構化摘要與管理後台

**版本**: 1.0 (Phase 2)
**日期**: 2025-12-17
**來源**: 需求文件 (Phase 2), Consolidated_Project_Plan.md

## 1. 系統架構概觀 (System Architecture Overview)

本階段將在既有的即時轉錄架構上，新增「管理後台 (Dashboard)」與「非同步處理管線 (Async Pipeline)」。

```plaintext
+-----------------------+       +-------------------------+
|  Frontend (Next.js)   |       |   Backend (FastAPI)     |
|  - Real-time Overlay  |<----->|  - WebSocket Gateway    |
|  - Admin Dashboard    |       |  - Auth Middleware (JWT)|
|    (Shadcn/ui)        |       |  - Task Dispatcher      |
+-----------------------+       +-------------------------+
          ^                                  |
          | (NextAuth)                       | (Celery/Redis)
          v                                  v
+-----------------------+       +-------------------------+
|   Auth Service        |       |   Worker Service        |
|  - NextAuth.js        |       |  - ASR (Long-form)      |
|  - Azure AD / Creds   |       |  - CrewAI (Summary)     |
+-----------------------+       +-------------------------+
```

## 2. 模組設計詳細規範 (Module Specifications)

### 2.1 身份驗證與授權模組 (Auth & RBAC)

*   **技術棧**: NextAuth.js (Auth.js) + FastAPI JWT
*   **前端設計**:
    *   **Provider**: 支援 `Credentials` (開發期) 與 `AzureAD` (生產期)。
    *   **Session**: 包含 `user_id`, `email`, `role`, `accessToken`。
    *   **保護路由**: `/dashboard/*` 僅限 `admin` 或特定授權群組訪問；`/transcribe` 需登入。
*   **後端設計**:
    *   **User Model**:
        ```python
        class User(Base):
            id: UUID
            email: String (Unique)
            hashed_password: String (Nullable, for local admin)
            role: Enum('admin', 'user', 'manager')
            department: String (Nullable)
            is_active: Boolean
        ```
    *   **Middleware**: 驗證 `Authorization: Bearer <token>` 表頭。解析 JWT，確認 `exp` (過期) 與 `scope/role`。

### 2.2 管理後台模組 (Admin Dashboard)

*   **技術棧**: Next.js (App Router) + Shadcn/ui + Tailwind CSS
*   **頁面結構**:
    *   `/dashboard`: 概覽（系統狀態、今日會議數、活躍使用者）。
    *   `/dashboard/users`: 使用者管理（列表、新增、編輯角色、停用）。
    *   `/dashboard/meetings`: 會議歷史管理（列表、詳情、**下載**）。
    *   `/dashboard/templates`: 結構化模板管理（**可視化編輯器**）。
*   **模板客製化實作**:
    *   **資料結構**: 模板定義儲存為 JSON Schema 格式。
        ```json
        {
          "template_name": "Weekly Sync",
          "sections": [
            {"key": "progress", "label": "本週進度", "type": "list"},
            {"key": "blockers", "label": "阻礙與風險", "type": "text"}
          ]
        }
        ```
    *   **前端 UI**: 實作一個 Form Builder (類似 Google Forms)，允許管理員新增 Section，設定標題與資料類型。
    *   **後端邏輯**: `Extractor Agent` 讀取此 JSON Schema，動態生成 Prompt 給 LLM (e.g., "Extract 'progress' as a list...").
*   **下載功能實作**:
    *   前端提供下拉選單：Download as TXT / SRT / JSON / PDF / DOCX。
    *   後端提供對應的轉換 API。
*   **UI 風格**: 採用 Shadcn/ui 的乾淨風格，深色模式支援 (Dark Mode)，側邊欄導航。

### 2.3 智慧摘要生成模組 (Intelligent Summary Engine)

*   **技術棧**: CrewAI + LangChain + Python Worker
*   **流程設計 (Pipeline)**:
    1.  **Trigger**: 會議結束(即時) 或 檔案上傳完成 -> 寫入 `tasks` 表 -> 推送至 Redis Queue。
    2.  **Worker**: 監聽 Queue，領取任務。
    3.  **Map Step**: 若逐字稿 token 數 > 8k，依語意分割為 chunks。啟動 `Summarizer Agent` 平行處理。
    4.  **Reduce Step**: `Summarizer Agent` 將片段摘要合併為全域摘要。
    5.  **Extract Step**: `Extractor Agent` 載入指定 Template (e.g., BANT)，從全域摘要與原始逐字稿中提取結構化欄位。
    6.  **Save**: 將結果存入 `meetings` 表的 `summary` 欄位 (JSONB)。
    7.  **Retention Policy**: 啟動每日排程 (Cron Job)，檢查 `created_at` > 6 個月的會議，自動刪除其 GCS 上的 `audio_path` 檔案與資料庫記錄 (或標記為封存)。
    8.  **Notify**: 透過 WebSocket 通知前端「報告已生成」。

### 2.4 多媒體處理模組 (Media Processing)

*   **技術棧**: FFmpeg + WhisperX (或 Faster-Whisper with Alignment)
*   **基礎設施**: 
    *   **Production**: GCP Cloud SQL for PostgreSQL + GCS
    *   **Local**: PostgreSQL 18 (Docker) + Local Filesystem
*   **功能**:
    *   **格式轉換**: 統一轉為 16kHz Mono WAV。
    *   **講者分離 (Diarization)**: (進階) 整合 PyAnnote 或類似模型，標記 Speaker A/B。
    *   **時間軸對齊**: 確保生成的逐字稿具有精確的 word-level timestamp，以支援點擊文字跳轉播放與 SRT 生成。
    *   **格式匯出**: 實作 `TranscriptConverter` class，支援將內部 JSON 轉為 SRT (含時間戳)、TXT (純文字)、DOCX (含排版)。

### 2.5 音訊處理優化模組 (Audio Processing Optimization)

*   **技術棧**: Web Audio API (AudioWorklet) + RNNoise (WASM)
*   **前端設計**:
    *   **AudioWorklet 實作**: 將 `ScriptProcessorNode` 替換為 `AudioWorkletNode`。建立一個 `AudioWorkletProcessor`，負責在獨立執行緒中處理音訊資料。
    *   **RNNoise 整合**: 在 `AudioWorkletProcessor` 內部，整合 `sapphi-red/web-noise-suppressor` 庫。將輸入音訊送入 RNNoise 進行降噪處理，然後將降噪後的音訊傳遞到後續的處理流程 (例如 PCM 編碼與 WebSocket 傳輸)。
    *   **效能考量**: 確保 AudioWorklet 的處理邏輯高效，避免引入新的延遲。

## 3. 資料庫設計 (Database Schema)

### 3.1 Users Table
| Column | Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| id | UUID | PK | |
| email | VARCHAR | Unique, Not Null | |
| password_hash | VARCHAR | Nullable | 僅本地帳號使用 |
| role | VARCHAR | Not Null | 'admin', 'user', etc. |
| department | VARCHAR | Nullable | 部門標籤 |
| created_at | TIMESTAMP | | |

### 3.2 Meetings Table
| Column | Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| id | UUID | PK | |
| user_id | UUID | FK -> Users.id | 會議擁有者 |
| title | VARCHAR | | |
| audio_path | VARCHAR | | 錄音檔路徑 (GCS/Local) |
| transcript | JSONB | | 原始逐字稿 (含 timestamp) |
| summary | JSONB | | 結構化摘要結果 |
| template_type | VARCHAR | | 使用的模板類型 (BANT, STAR...) |
| status | VARCHAR | | 'processing', 'completed', 'failed' |
| created_at | TIMESTAMP | | 用於 6 個月保留政策檢查 |

## 4. API 介面擴充 (API Extension)

*   `POST /api/v1/meetings/upload`: 上傳錄音檔 (觸發完整轉錄)。
*   `GET /api/v1/meetings/{id}/download`: 下載逐字稿，支援 `?format=txt|srt|json|docx` 參數。
*   `GET /api/v1/meetings/{id}`: 獲取會議詳情 (含摘要)。
*   `GET /api/v1/meetings`: 獲取會議列表 (支援分頁、過濾)。
*   `POST /api/v1/templates`: 新增/更新摘要模板。
*   `POST /api/v1/auth/login`: (最後實作) 登入介面。
*   `GET /api/v1/users/me`: (最後實作) 獲取當前使用者資訊。
