# MeetChi 企業級可靠性架構規劃

> 版本：v1.0 | 日期：2026-02-04

## 目標

為 2500 人公司設計高可靠性會議錄製系統：
- **規模**：50-80 場會議/天，1 小時/場
- **零容錯**：用戶不接受任何數據丟失
- **背景處理**：用戶不需等待轉錄/摘要完成
- **自動通知**：處理完成後主動通知用戶

---

## 第一性原理分析

### 核心問題：數據從何處產生，又在何處可能丟失？

```
音訊數據生命週期：
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 麥克風  │ →  │ 瀏覽器  │ →  │ 網路    │ →  │ 後端    │ →  │ 儲存    │
│ 捕獲    │    │ 緩衝    │    │ 傳輸    │    │ 處理    │    │ 持久化  │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
     ↓              ↓              ↓              ↓              ↓
  失敗點 1       失敗點 2       失敗點 3       失敗點 4       失敗點 5
```

---

## MECE 失敗情境分析

### 分類一：按生命週期階段

| 階段 | 失敗情境 | 發生概率 | 影響程度 |
|------|---------|---------|---------|
| **捕獲** | 麥克風權限被拒、裝置斷開 | 低 | 致命 |
| **緩衝** | 瀏覽器崩潰、記憶體不足 | 中 | 致命 |
| **傳輸** | 網路中斷、WebSocket 斷線 | 高 | 可恢復 |
| **處理** | 服務崩潰、超時 | 中 | 可恢復 |
| **儲存** | 寫入失敗、磁碟滿 | 低 | 致命 |

### 分類二：按恢復難度

| 類型 | 情境 | 恢復策略 |
|------|------|---------|
| **可即時恢復** | 網路閃斷（<5 秒） | 自動重連 + 緩衝補發 |
| **可延遲恢復** | 後端處理失敗 | 任務重試 |
| **無法恢復** | 瀏覽器崩潰 + 未備份 | 🚨 數據永久丟失 |

---

## 方案設計

### 方案 A：前端本地備份 + Cloud Tasks（推薦）

```
┌────────────────────────────────────────────────────────────────────┐
│                          前端（瀏覽器）                             │
├────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐            │
│  │ MediaRecorder│ →  │ IndexedDB   │ →  │ 分塊上傳    │            │
│  │ (錄音)       │    │ (本地備份)  │    │ (5分鐘/塊)  │            │
│  └─────────────┘    └─────────────┘    └─────────────┘            │
│                           ↓                   ↓                    │
│                      崩潰恢復              網路中斷恢復             │
└────────────────────────────────────────────────────────────────────┘
                                    ↓
┌────────────────────────────────────────────────────────────────────┐
│                          GCP 後端                                  │
├────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐            │
│  │ Cloud Run   │ →  │ Cloud Tasks │ →  │ LLM Service │            │
│  │ (API)       │    │ (佇列)      │    │ (處理)      │            │
│  └─────────────┘    └─────────────┘    └─────────────┘            │
│         ↓                   ↓                   ↓                  │
│    Cloud SQL          自動重試            Cloud Storage            │
└────────────────────────────────────────────────────────────────────┘
```

**防護措施：**

| 失敗點 | 防護機制 |
|--------|---------|
| 瀏覽器崩潰 | IndexedDB 本地備份，重開瀏覽器可恢復 |
| 網路中斷 | 分塊上傳 + 斷點續傳 |
| 後端崩潰 | Cloud Tasks 自動重試（最多 5 次） |
| 處理失敗 | Dead Letter Queue + 人工介入 |

**成本估算：**

| 服務 | 用量估算 | 月費 |
|------|---------|------|
| Cloud Tasks | 80場×30天×3任務 = 7,200 次/月 | **免費** |
| Cloud Storage | 80場×1小時×50MB = 120GB/月 | ~$2.5 |
| Cloud Run (API) | 已有 | 已計算 |
| Cloud Run (LLM) | 已有 | 已計算 |
| **新增成本** | | **~$2.5/月** |

---

### 方案 B：Celery + Redis（原設計）

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ API     │ →  │ Redis   │ →  │ Celery  │ →  │ LLM     │
│         │    │ (佇列)  │    │ Worker  │    │ Service │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
```

**成本估算：**

| 服務 | 規格 | 月費 |
|------|------|------|
| Memorystore Redis | 1GB BASIC | ~$35-50 |
| Celery Worker | 需獨立 Cloud Run | ~$20-40 |
| **新增成本** | | **~$55-90/月** |

---

### 方案 C：純 DB 任務表（最低成本）

```
┌─────────┐    ┌─────────┐    ┌─────────┐
│ API     │ →  │ 任務表  │ ←  │ 輪詢    │
│ (寫入)  │    │ (SQL)   │    │ Worker  │
└─────────┘    └─────────┘    └─────────┘
```

**成本估算：**

| 服務 | 用量 | 月費 |
|------|------|------|
| Cloud SQL | 已有 | 已計算 |
| Cloud Scheduler | 1分鐘輪詢 | 免費 |
| **新增成本** | | **$0** |

**缺點**：輪詢延遲、無自動重試、可靠性較低

---

## 方案比較

| 指標 | 方案 A (Cloud Tasks) | 方案 B (Celery) | 方案 C (純 DB) |
|------|---------------------|-----------------|---------------|
| **月成本** | ~$2.5 | ~$55-90 | $0 |
| **可靠性** | ★★★★★ | ★★★★☆ | ★★★☆☆ |
| **自動重試** | ✅ 原生支援 | ✅ 原生支援 | ❌ 需自建 |
| **Dead Letter** | ✅ 原生支援 | ⚠️ 需配置 | ❌ 需自建 |
| **GCP 整合** | ★★★★★ | ★★☆☆☆ | ★★★☆☆ |
| **實作複雜度** | 中 | 高 | 低 |
| **擴展性** | 無限 | 受限於 Worker | 受限於輪詢 |

---

## 建議方案

> [!IMPORTANT]
> **推薦方案 A：前端本地備份 + Cloud Tasks**

**理由：**
1. **成本**：比 Celery 省 $50-90/月（年省 $600-1080）
2. **可靠性**：GCP 原生服務，99.99% SLA
3. **零丟失**：前端 IndexedDB 備份 + 分塊上傳
4. **自動重試**：Cloud Tasks 最多重試 5 次

---

## 實施步驟

### Phase 1：前端可靠性增強

- [ ] 1.1 實作 IndexedDB 本地錄音備份
- [ ] 1.2 實作分塊上傳（每 5 分鐘一塊）
- [ ] 1.3 實作崩潰恢復機制
- [ ] 1.4 實作網路中斷檢測 + 斷點續傳

### Phase 2：後端任務佇列

- [ ] 2.1 建立 Cloud Tasks 佇列
- [ ] 2.2 修改 API：上傳完成後建立 Task
- [ ] 2.3 建立 Task Handler（Cloud Run endpoint）
- [ ] 2.4 設定 Dead Letter Topic + 告警

### Phase 3：通知系統

- [ ] 3.1 整合 Email 通知（SendGrid/Mailgun）
- [ ] 3.2 整合瀏覽器推播通知（可選）
- [ ] 3.3 建立處理狀態追蹤 UI

### Phase 4：移除冗餘服務

- [ ] 4.1 從 Terraform 移除 Memorystore Redis
- [ ] 4.2 從 requirements.txt 移除 redis/celery
- [ ] 4.3 更新部署文件

---

## 風險評估

| 風險 | 可能性 | 影響 | 緩解措施 |
|------|--------|------|---------|
| IndexedDB 容量不足 | 低 | 中 | 監控 + 自動清理舊數據 |
| Cloud Tasks 延遲 | 低 | 低 | 設定優先級 |
| 前端代碼複雜度增加 | 中 | 中 | 良好的抽象設計 |
| 用戶禁用 IndexedDB | 極低 | 高 | 提示用戶啟用 |

---

## 驗證計畫

### 自動化測試

- [ ] 模擬網路中斷，驗證斷點續傳
- [ ] 模擬瀏覽器崩潰，驗證恢復機制
- [ ] 模擬 Cloud Tasks 失敗，驗證重試

### 壓力測試

- [ ] 模擬 80 場並發會議
- [ ] 驗證 Cloud Tasks 吞吐量
- [ ] 監控系統資源使用

---

## 成本總結

| 項目 | 方案 A | 方案 B |
|------|--------|--------|
| Cloud Tasks | 免費 | - |
| Memorystore Redis | - | $35-50 |
| 額外 Storage | $2.5 | $2.5 |
| **月總成本差異** | **基準** | **+$35-50** |
| **年節省** | - | **$420-600** |
